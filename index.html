<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f7; color: #1d1d1f; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); padding: 20px 0; border-bottom: 1px solid rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .nav { display: flex; justify-content: center; gap: 30px; }
        .nav-btn { background: none; border: none; font-size: 17px; font-weight: 500; color: #86868b; cursor: pointer; padding: 8px 16px; border-radius: 20px; transition: all 0.3s ease; }
        .nav-btn.active { color: #007aff; background: rgba(0,122,255,0.1); }
        .nav-btn:hover { color: #007aff; }
        .page { display: none; padding: 40px 0; }
        .page.active { display: block; }
        .card { background: white; border-radius: 16px; padding: 30px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.05); }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #1d1d1f; }
        .input-group input, .input-group select { width: 100%; padding: 12px 16px; border: 1px solid #d2d2d7; border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: #007aff; }
        .btn { background: #007aff; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
        .btn:hover { background: #0056b3; transform: translateY(-1px); }
        .btn.secondary { background: #f2f2f7; color: #1d1d1f; }
        .btn.secondary:hover { background: #e5e5ea; }
        .btn.danger { background: #ff3b30; }
        .btn.danger:hover { background: #d70015; }
        .btn.success { background: #34c759; }
        .btn.success:hover { background: #248a3d; }
        .timer-section { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        .timer-display { text-align: center; min-width: 120px; }
        .timer-time { font-size: 32px; font-weight: 300; color: #007aff; font-variant-numeric: tabular-nums; margin: 0; }
        .timer-activity { font-size: 14px; color: #86868b; margin-top: 5px; }
        .timer-controls { display: flex; gap: 10px; flex-shrink: 0; }
        .btn-icon { background: #007aff; color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .btn-icon.success { background: #34c759; }
        .btn-icon.success:hover { background: #248a3d; }
        .btn-icon.danger { background: #ff3b30; }
        .btn-icon.danger:hover { background: #d70015; }
        .btn-icon:disabled { background: #d2d2d7; cursor: not-allowed; transform: none; box-shadow: none; }
        .activity-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #f8f9fa; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease; }
        .activity-item:hover { background: #e9ecef; transform: translateY(-1px); }
        .activity-item.selected { background: #007aff; color: white; }
        .activity-item.selected .activity-info p { color: rgba(255,255,255,0.8); }
        .activity-info h3 { margin-bottom: 4px; font-size: 16px; }
        .activity-info p { margin: 0; font-size: 14px; }
        .activity-actions { display: flex; gap: 8px; flex-shrink: 0; }
        .activity-actions button { padding: 8px 16px; font-size: 14px; white-space: nowrap; }
        .mobile-stack { display: flex; flex-direction: column; gap: 15px; }
        .mobile-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .mobile-header h2 { margin: 0; }
        .mobile-timer { background: #f8f9fa; padding: 15px; border-radius: 12px; text-align: center; }
        .mobile-timer .timer-time { font-size: 28px; }
        .mobile-timer .timer-activity { font-size: 12px; margin-top: 5px; margin-bottom: 10px; }
        .mobile-timer .timer-controls { justify-content: center; }
        .activity-info h3 { color: #1d1d1f; margin-bottom: 4px; }
        .activity-info p { color: #86868b; font-size: 14px; }
        .activity-actions { display: flex; gap: 10px; }
        .activity-actions button { padding: 6px 12px; font-size: 14px; }
        .filters { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .chart-container { position: relative; height: 400px; margin-top: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: 600; margin-bottom: 5px; }
        .stat-label { font-size: 14px; opacity: 0.8; }
        .empty-state { text-align: center; padding: 60px 20px; color: #86868b; }
        .empty-state h3 { margin-bottom: 10px; }
        .archived-badge { background: #ff9500; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 10px; }
        @media (max-width: 768px) {
            .nav { flex-direction: column; align-items: center; }
            .timer-time { font-size: 36px; }
            .activity-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .filters { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <nav class="nav">
                <button class="nav-btn active" onclick="showPage('home')">Home</button>
                <button class="nav-btn" onclick="showPage('storico')">Storico</button>
                <button class="nav-btn" onclick="showPage('archiviate')">Archiviate</button>
            </nav>
        </div>
    </div>

    <div class="container">
        <!-- HOME PAGE -->
        <div id="home" class="page active">
            <div class="card">
                <h2>Nuova Attività</h2>
                <div class="input-group">
                    <label for="activityName">Nome Attività</label>
                    <input type="text" id="activityName" placeholder="Inserisci il nome dell'attività">
                </div>
                <div class="input-group">
                    <label for="activityCategory">Categoria</label>
                    <select id="activityCategory">
                        <option value="Lavoro">Lavoro</option>
                        <option value="Studio">Studio</option>
                        <option value="Personale">Personale</option>
                        <option value="Sport">Sport</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>
                <button class="btn" onclick="addActivity()">Aggiungi Attività</button>
            </div>

            <div class="card">
                <div class="mobile-header">
                    <h2>Attività Attive</h2>
                    <div class="mobile-timer">
                        <div class="timer-time" id="timerDisplay">00:00:00</div>
                        <div class="timer-activity" id="currentActivity">Seleziona un'attività</div>
                        <div class="timer-controls">
                            <button class="btn-icon success" id="startBtn" onclick="startTimer()" disabled>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </button>
                            <button class="btn-icon danger" id="stopBtn" onclick="stopTimer()" disabled>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <rect x="6" y="6" width="12" height="12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="desktop-timer" style="display: none;">
                    <div class="timer-section">
                        <div class="timer-display">
                            <div class="timer-time" id="timerDisplayDesktop">00:00:00</div>
                            <div class="timer-activity" id="currentActivityDesktop">Seleziona un'attività</div>
                        </div>
                        <div class="timer-controls">
                            <button class="btn-icon success" id="startBtnDesktop" onclick="startTimer()" disabled>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </button>
                            <button class="btn-icon danger" id="stopBtnDesktop" onclick="stopTimer()" disabled>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <rect x="6" y="6" width="12" height="12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="activeActivities"></div>
            </div>
        </div>

        <!-- STORICO PAGE -->
        <div id="storico" class="page">
            <div class="card">
                <h2>Statistiche</h2>
                <div class="filters">
                    <select id="periodFilter" onchange="updateStats()">
                        <option value="day">Oggi</option>
                        <option value="week">Questa settimana</option>
                        <option value="month">Questo mese</option>
                        <option value="year">Quest'anno</option>
                    </select>
                </div>
                <div class="stats-grid" id="statsGrid"></div>
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ARCHIVIATE PAGE -->
        <div id="archiviate" class="page">
            <div class="card">
                <h2>Attività Archiviate</h2>
                <div id="archivedActivities"></div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDiaUWF-Um_oFCMuQ7U3S17IKfTv3Pp0B0",
            authDomain: "timetracker-20f52.firebaseapp.com",
            projectId: "timetracker-20f52",
            storageBucket: "timetracker-20f52.firebasestorage.app",
            messagingSenderId: "1034650241143",
            appId: "1:1034650241143:web:f86f432b878baddc991e72",
            measurementId: "G-45C3MSZDK8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let currentTimer = null;
        let startTime = null;
        let currentActivityId = null;
        let chart = null;

        // Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
            
            if (pageId === 'storico') updateStats();
            if (pageId === 'archiviate') loadArchivedActivities();
        }

        // Activity Management
        async function addActivity() {
            const name = document.getElementById('activityName').value.trim();
            const category = document.getElementById('activityCategory').value;
            
            if (!name) {
                alert('Inserisci il nome dell\'attività');
                return;
            }

            try {
                const docRef = await db.collection('activities').add({
                    name: name,
                    category: category,
                    createdAt: new Date(),
                    archived: false,
                    totalTime: 0
                });
                
                console.log('Attività aggiunta con ID:', docRef.id);
                document.getElementById('activityName').value = '';
                loadActiveActivities();
            } catch (error) {
                console.error('Errore nell\'aggiunta dell\'attività:', error);
                alert('Errore nell\'aggiunta dell\'attività: ' + error.message);
            }
        }

        async function loadActiveActivities() {
            try {
                const snapshot = await db.collection('activities').where('archived', '==', false).get();
                const container = document.getElementById('activeActivities');
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state"><h3>Nessuna attività attiva</h3><p>Aggiungi una nuova attività per iniziare</p></div>';
                    return;
                }

                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const activity = doc.data();
                    const div = document.createElement('div');
                    div.className = 'activity-item';
                    div.setAttribute('data-id', doc.id);
                    div.onclick = () => selectActivity(doc.id, activity.name);
                    div.innerHTML = `
                        <div class="activity-info">
                            <h3>${activity.name}</h3>
                            <p>${activity.category} • ${formatTime(activity.totalTime || 0)}</p>
                        </div>
                        <div class="activity-actions">
                            <button class="btn secondary" onclick="event.stopPropagation(); archiveActivity('${doc.id}')">Archivia</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Errore nel caricamento delle attività:', error);
            }
        }

        function selectActivity(id, name) {
            // Remove selection from all activities
            document.querySelectorAll('.activity-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to clicked activity
            document.querySelector(`[data-id="${id}"]`).classList.add('selected');
            
            currentActivityId = id;
            
            // Update both mobile and desktop displays
            const mobileActivity = document.getElementById('currentActivity');
            const desktopActivity = document.getElementById('currentActivityDesktop');
            
            if (mobileActivity) mobileActivity.textContent = name;
            if (desktopActivity) desktopActivity.textContent = name;
            
            // Enable start buttons
            const startBtns = document.querySelectorAll('#startBtn, #startBtnDesktop');
            startBtns.forEach(btn => btn.disabled = false);
        }

        function selectActivity(id, name) {
            currentActivityId = id;
            document.getElementById('currentActivity').textContent = name;
            document.getElementById('startBtn').disabled = false;
        }

        // Timer Management
        function startTimer() {
            if (!currentActivityId) return;
            
            startTime = Date.now();
            currentTimer = setInterval(updateTimerDisplay, 1000);
            
            // Disable start buttons, enable stop buttons
            const startBtns = document.querySelectorAll('#startBtn, #startBtnDesktop');
            const stopBtns = document.querySelectorAll('#stopBtn, #stopBtnDesktop');
            
            startBtns.forEach(btn => btn.disabled = true);
            stopBtns.forEach(btn => btn.disabled = false);
        }

        async function stopTimer() {
            if (!currentTimer || !currentActivityId) return;
            
            clearInterval(currentTimer);
            const endTime = Date.now();
            const duration = endTime - startTime;
            
            try {
                // Save time entry
                await db.collection('timeEntries').add({
                    activityId: currentActivityId,
                    startTime: new Date(startTime),
                    endTime: new Date(endTime),
                    duration: duration,
                    date: new Date().toISOString().split('T')[0]
                });
                
                // Update activity total time
                const activityRef = db.collection('activities').doc(currentActivityId);
                const activityDoc = await activityRef.get();
                const currentTotal = activityDoc.data().totalTime || 0;
                await activityRef.update({
                    totalTime: currentTotal + duration
                });
                
                // Reset timer displays
                currentTimer = null;
                startTime = null;
                
                const mobileDisplay = document.getElementById('timerDisplay');
                const desktopDisplay = document.getElementById('timerDisplayDesktop');
                const mobileActivity = document.getElementById('currentActivity');
                const desktopActivity = document.getElementById('currentActivityDesktop');
                
                if (mobileDisplay) mobileDisplay.textContent = '00:00:00';
                if (desktopDisplay) desktopDisplay.textContent = '00:00:00';
                if (mobileActivity) mobileActivity.textContent = 'Seleziona un\'attività';
                if (desktopActivity) desktopActivity.textContent = 'Seleziona un\'attività';
                
                // Reset button states
                const startBtns = document.querySelectorAll('#startBtn, #startBtnDesktop');
                const stopBtns = document.querySelectorAll('#stopBtn, #stopBtnDesktop');
                
                startBtns.forEach(btn => btn.disabled = true);
                stopBtns.forEach(btn => btn.disabled = true);
                
                // Remove selection from all activities
                document.querySelectorAll('.activity-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                currentActivityId = null;
                
                loadActiveActivities();
            } catch (error) {
                console.error('Errore nel salvataggio del tempo:', error);
                alert('Errore nel salvataggio del tempo');
            }
        }

        function updateTimerDisplay() {
            if (!startTime) return;
            const elapsed = Date.now() - startTime;
            const formattedTime = formatTime(elapsed);
            
            // Update both mobile and desktop displays
            const mobileDisplay = document.getElementById('timerDisplay');
            const desktopDisplay = document.getElementById('timerDisplayDesktop');
            
            if (mobileDisplay) mobileDisplay.textContent = formattedTime;
            if (desktopDisplay) desktopDisplay.textContent = formattedTime;
        }

        // Archive Management
        async function archiveActivity(id) {
            try {
                await db.collection('activities').doc(id).update({
                    archived: true,
                    archivedAt: new Date()
                });
                loadActiveActivities();
                console.log('Attività archiviata con successo');
            } catch (error) {
                console.error('Errore nell\'archiviazione:', error);
                alert('Errore nell\'archiviazione dell\'attività: ' + error.message);
            }
        }

        async function restoreActivity(id) {
            try {
                await db.collection('activities').doc(id).update({
                    archived: false
                });
                loadArchivedActivities();
                console.log('Attività ripristinata con successo');
            } catch (error) {
                console.error('Errore nel ripristino:', error);
                alert('Errore nel ripristino dell\'attività: ' + error.message);
            }
        }

        async function loadArchivedActivities() {
            try {
                const snapshot = await db.collection('activities').where('archived', '==', true).get();
                const container = document.getElementById('archivedActivities');
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state"><h3>Nessuna attività archiviata</h3><p>Le attività archiviate appariranno qui</p></div>';
                    return;
                }

                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const activity = doc.data();
                    const div = document.createElement('div');
                    div.className = 'activity-item';
                    div.innerHTML = `
                        <div class="activity-info">
                            <h3>${activity.name} <span class="archived-badge">Archiviata</span></h3>
                            <p>${activity.category} • ${formatTime(activity.totalTime || 0)}</p>
                        </div>
                        <div class="activity-actions">
                            <button class="btn" onclick="restoreActivity('${doc.id}')">Ripristina</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
                console.log('Caricate', snapshot.size, 'attività archiviate');
            } catch (error) {
                console.error('Errore nel caricamento delle attività archiviate:', error);
            }
        }

        // Statistics
        async function updateStats() {
            const period = document.getElementById('periodFilter').value;
            const dateRange = getDateRange(period);
            
            try {
                const snapshot = await db.collection('timeEntries')
                    .where('date', '>=', dateRange.start)
                    .where('date', '<=', dateRange.end)
                    .get();
                
                const stats = processStats(snapshot);
                displayStats(stats);
                updateChart(stats);
            } catch (error) {
                console.error('Errore nel caricamento delle statistiche:', error);
            }
        }

        function getDateRange(period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch (period) {
                case 'day':
                    return {
                        start: today.toISOString().split('T')[0],
                        end: today.toISOString().split('T')[0]
                    };
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    return {
                        start: weekStart.toISOString().split('T')[0],
                        end: today.toISOString().split('T')[0]
                    };
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    return {
                        start: monthStart.toISOString().split('T')[0],
                        end: today.toISOString().split('T')[0]
                    };
                case 'year':
                    const yearStart = new Date(today.getFullYear(), 0, 1);
                    return {
                        start: yearStart.toISOString().split('T')[0],
                        end: today.toISOString().split('T')[0]
                    };
            }
        }

        function processStats(snapshot) {
            const activities = {};
            let totalTime = 0;
            
            snapshot.forEach(doc => {
                const entry = doc.data();
                const duration = entry.duration || 0;
                totalTime += duration;
                
                if (!activities[entry.activityId]) {
                    activities[entry.activityId] = {
                        duration: 0,
                        sessions: 0
                    };
                }
                
                activities[entry.activityId].duration += duration;
                activities[entry.activityId].sessions++;
            });
            
            return {
                totalTime,
                activities,
                totalSessions: snapshot.size
            };
        }

        function displayStats(stats) {
            const container = document.getElementById('statsGrid');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${formatTime(stats.totalTime)}</div>
                    <div class="stat-label">Tempo Totale</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalSessions}</div>
                    <div class="stat-label">Sessioni</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Object.keys(stats.activities).length}</div>
                    <div class="stat-label">Attività</div>
                </div>
            `;
        }

        function updateChart(stats) {
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            const labels = [];
            const data = [];
            const colors = ['#007aff', '#34c759', '#ff9500', '#ff3b30', '#af52de', '#5ac8fa'];
            
            Object.entries(stats.activities).forEach(([activityId, activity], index) => {
                labels.push(`Attività ${index + 1}`);
                data.push(Math.round(activity.duration / 60000)); // Convert to minutes
            });
            
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, data.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Utility Functions
        function formatTime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadActiveActivities();
        });
    </script>
</body>
</html>
