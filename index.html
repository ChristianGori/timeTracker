<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f7; color: #1d1d1f; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Header and Navigation */
        .header { background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); padding: 15px 0; border-bottom: 1px solid rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .nav-container { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 20px; font-weight: 600; color: #1d1d1f; }
        
        /* Desktop Navigation */
        .nav-desktop { display: flex; gap: 30px; }
        .nav-desktop .nav-btn { background: none; border: none; font-size: 16px; font-weight: 500; color: #86868b; cursor: pointer; padding: 8px 16px; border-radius: 20px; transition: all 0.3s ease; }
        .nav-desktop .nav-btn.active { color: #007aff; background: rgba(0,122,255,0.1); }
        .nav-desktop .nav-btn:hover { color: #007aff; }
        
        /* Mobile Navigation */
        .nav-mobile { display: none; }
        .hamburger { background: none; border: none; cursor: pointer; padding: 8px; }
        .hamburger span { display: block; width: 20px; height: 2px; background: #1d1d1f; margin: 4px 0; transition: 0.3s; }
        .hamburger.active span:nth-child(1) { transform: rotate(-45deg) translate(-4px, 4px); }
        .hamburger.active span:nth-child(2) { opacity: 0; }
        .hamburger.active span:nth-child(3) { transform: rotate(45deg) translate(-4px, -4px); }
        
        .mobile-menu { position: fixed; top: 0; right: -100%; width: 280px; height: 100vh; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s ease; padding: 60px 20px 20px; z-index: 101; }
        .mobile-menu.active { right: 0; }
        .mobile-menu .nav-btn { display: block; width: 100%; background: none; border: none; font-size: 18px; font-weight: 500; color: #1d1d1f; cursor: pointer; padding: 15px 0; border-bottom: 1px solid #f0f0f0; transition: all 0.3s ease; text-align: left; }
        .mobile-menu .nav-btn.active { color: #007aff; }
        .mobile-menu .nav-btn:hover { color: #007aff; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: all 0.3s ease; z-index: 100; }
        .overlay.active { opacity: 1; visibility: visible; }
        
        .page { display: none; padding: 20px 0; }
        .page.active { display: block; }
        .card { background: white; border-radius: 16px; padding: 30px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.05); }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #1d1d1f; }
        .input-group input, .input-group select { width: 100%; padding: 12px 16px; border: 1px solid #d2d2d7; border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: #007aff; }
        .btn { background: #007aff; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
        .btn:hover { background: #0056b3; transform: translateY(-1px); }
        .btn.secondary { background: #f2f2f7; color: #1d1d1f; }
        .btn.secondary:hover { background: #e5e5ea; }
        .btn.danger { background: #ff3b30; }
        .btn.danger:hover { background: #d70015; }
        .btn.success { background: #34c759; }
        .btn.success:hover { background: #248a3d; }
        
        /* Timer Section - Centered */
        .timer-section { display: flex; flex-direction: column; align-items: center; gap: 20px; background: #f8f9fa; padding: 30px; border-radius: 16px; margin-bottom: 30px; }
        .timer-display { text-align: center; }
        .timer-time { font-size: 48px; font-weight: 200; color: #007aff; font-variant-numeric: tabular-nums; margin: 0; }
        .timer-activity { font-size: 16px; color: #86868b; margin: 10px 0; }
        .timer-controls { display: flex; gap: 15px; }
        .btn-icon { background: #007aff; color: white; border: none; padding: 15px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        .btn-icon.success { background: #34c759; }
        .btn-icon.success:hover { background: #248a3d; }
        .btn-icon.danger { background: #ff3b30; }
        .btn-icon.danger:hover { background: #d70015; }
        .btn-icon:disabled { background: #d2d2d7; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .activity-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #f8f9fa; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease; }
        .activity-item:hover { background: #e9ecef; transform: translateY(-1px); }
        .activity-item.selected { background: #007aff; color: white; }
        .activity-item.selected .activity-info p { color: rgba(255,255,255,0.8); }
        .activity-info h3 { margin-bottom: 4px; font-size: 16px; color: #1d1d1f; }
        .activity-info p { margin: 0; font-size: 14px; color: #86868b; }
        .activity-actions { display: flex; gap: 8px; flex-shrink: 0; }
        .activity-actions button { padding: 8px 16px; font-size: 14px; white-space: nowrap; }
        
        .filters { margin-bottom: 30px; }
        .filter-tabs { display: flex; background: #f2f2f7; border-radius: 12px; padding: 4px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-tab { flex: 1; padding: 12px 20px; border: none; background: transparent; color: #86868b; font-weight: 500; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; text-align: center; min-width: 120px; }
        .filter-tab.active { background: white; color: #007aff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .filter-tab:hover { color: #007aff; }
        .custom-date-section { background: white; border-radius: 12px; padding: 20px; display: none; }
        .custom-date-section.active { display: block; }
        .custom-date-inputs { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .date-input-group { display: flex; flex-direction: column; gap: 5px; }
        .date-input-group label { font-size: 14px; font-weight: 500; color: #1d1d1f; }
        .date-input-group input { padding: 10px 12px; border: 1px solid #d2d2d7; border-radius: 8px; font-size: 14px; }
        .chart-container { position: relative; height: 400px; margin-bottom: 30px; background: white; padding: 20px; border-radius: 12px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: 600; margin-bottom: 5px; }
        .stat-label { font-size: 14px; opacity: 0.8; }
        .empty-state { text-align: center; padding: 60px 20px; color: #86868b; }
        .empty-state h3 { margin-bottom: 10px; }
        .archived-badge { background: #ff9500; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 10px; }
        
        @media (max-width: 768px) {
            .nav-desktop { display: none; }
            .nav-mobile { display: block; }
            .timer-time { font-size: 36px; }
            .timer-section { padding: 20px; }
            .activity-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .filters { flex-direction: column; }
            .filter-tabs { flex-direction: column; }
            .filter-tab { min-width: unset; }
            .custom-date-inputs { flex-direction: column; align-items: stretch; }
            .date-input-group { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="nav-container">
                <div class="logo">Time Tracker</div>
                
                <!-- Desktop Navigation -->
                <nav class="nav-desktop">
                    <button class="nav-btn active" onclick="showPage('home')">Home</button>
                    <button class="nav-btn" onclick="showPage('storico')">Storico</button>
                    <button class="nav-btn" onclick="showPage('archiviate')">Archiviate</button>
                </nav>
                
                <!-- Mobile Navigation -->
                <div class="nav-mobile">
                    <button class="hamburger" onclick="toggleMobileMenu()">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <button class="nav-btn active" onclick="showPage('home'); closeMobileMenu()">Home</button>
        <button class="nav-btn" onclick="showPage('storico'); closeMobileMenu()">Storico</button>
        <button class="nav-btn" onclick="showPage('archiviate'); closeMobileMenu()">Archiviate</button>
    </div>
    <div class="overlay" id="overlay" onclick="closeMobileMenu()"></div>

    <div class="container">
        <!-- HOME PAGE -->
        <div id="home" class="page active">
            <div class="card">
                <h2>Nuova Attività</h2>
                <div class="input-group">
                    <label for="activityName">Nome Attività</label>
                    <input type="text" id="activityName" placeholder="Inserisci il nome dell'attività">
                </div>
                <div class="input-group">
                    <label for="activityCategory">Categoria</label>
                    <select id="activityCategory">
                        <option value="Lavoro">Lavoro</option>
                        <option value="Studio">Studio</option>
                        <option value="Personale">Personale</option>
                        <option value="Sport">Sport</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>
                <button class="btn" onclick="addActivity()">Aggiungi Attività</button>
            </div>

            <div class="card">
                <h2>Attività Attive</h2>
                
                <!-- Timer Section - Centered -->
                <div class="timer-section">
                    <div class="timer-display">
                        <div class="timer-time" id="timerDisplay">00:00:00</div>
                        <div class="timer-activity" id="currentActivity">Seleziona un'attività</div>
                    </div>
                    <div class="timer-controls">
                        <button class="btn-icon success" id="startBtn" onclick="startTimer()" disabled>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        </button>
                        <button class="btn-icon danger" id="stopBtn" onclick="stopTimer()" disabled>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <rect x="6" y="6" width="12" height="12"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div id="activeActivities"></div>
            </div>
        </div>

        <!-- STORICO PAGE -->
        <div id="storico" class="page">
            <div class="card">
                <h2>Statistiche e Andamento Temporale</h2>
                <div class="filters">
                    <div class="filter-tabs">
                        <button class="filter-tab active" onclick="selectPeriod('day')">Ultimi 7 giorni</button>
                        <button class="filter-tab" onclick="selectPeriod('week')">Ultime 4 settimane</button>
                        <button class="filter-tab" onclick="selectPeriod('month')">Ultimi 6 mesi</button>
                        <button class="filter-tab" onclick="selectPeriod('year')">Ultimo anno</button>
                        <button class="filter-tab" onclick="selectPeriod('custom')">Personalizzato</button>
                    </div>
                    <div class="custom-date-section" id="customDateSection">
                        <div class="custom-date-inputs">
                            <div class="date-input-group">
                                <label>Data inizio</label>
                                <input type="date" id="startDate">
                            </div>
                            <div class="date-input-group">
                                <label>Data fine</label>
                                <input type="date" id="endDate">
                            </div>
                            <button class="btn" onclick="applyCustomDates()">Applica</button>
                        </div>
                    </div>
                </div>
                <div class="stats-grid" id="statsGrid"></div>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ARCHIVIATE PAGE -->
        <div id="archiviate" class="page">
            <div class="card">
                <h2>Attività Archiviate</h2>
                <div id="archivedActivities"></div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDiaUWF-Um_oFCMuQ7U3S17IKfTv3Pp0B0",
            authDomain: "timetracker-20f52.firebaseapp.com",
            projectId: "timetracker-20f52",
            storageBucket: "timetracker-20f52.firebasestorage.app",
            messagingSenderId: "1034650241143",
            appId: "1:1034650241143:web:f86f432b878baddc991e72",
            measurementId: "G-45C3MSZDK8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let currentTimer = null;
        let startTime = null;
        let currentActivityId = null;
        let timelineChart = null;
        let pieChart = null;
        let selectedPeriod = 'day';

        // Mobile Menu Functions
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('overlay');
            const hamburger = document.querySelector('.hamburger');
            
            mobileMenu.classList.toggle('active');
            overlay.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        function closeMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('overlay');
            const hamburger = document.querySelector('.hamburger');
            
            mobileMenu.classList.remove('active');
            overlay.classList.remove('active');
            hamburger.classList.remove('active');
        }

        // Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            // Update active state for both desktop and mobile nav
            const activeButtons = document.querySelectorAll(`.nav-btn[onclick*="${pageId}"]`);
            activeButtons.forEach(btn => btn.classList.add('active'));
            
            if (pageId === 'storico') updateStats();
            if (pageId === 'archiviate') loadArchivedActivities();
        }

        // Activity Management
        async function addActivity() {
            const name = document.getElementById('activityName').value.trim();
            const category = document.getElementById('activityCategory').value;
            
            if (!name) {
                alert('Inserisci il nome dell\'attività');
                return;
            }

            try {
                const docRef = await db.collection('activities').add({
                    name: name,
                    category: category,
                    createdAt: new Date(),
                    archived: false,
                    totalTime: 0
                });
                
                console.log('Attività aggiunta con ID:', docRef.id);
                document.getElementById('activityName').value = '';
                loadActiveActivities();
            } catch (error) {
                console.error('Errore nell\'aggiunta dell\'attività:', error);
                alert('Errore nell\'aggiunta dell\'attività: ' + error.message);
            }
        }

        async function loadActiveActivities() {
            try {
                const snapshot = await db.collection('activities').where('archived', '==', false).get();
                const container = document.getElementById('activeActivities');
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state"><h3>Nessuna attività attiva</h3><p>Aggiungi una nuova attività per iniziare</p></div>';
                    return;
                }

                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const activity = doc.data();
                    const div = document.createElement('div');
                    div.className = 'activity-item';
                    div.setAttribute('data-id', doc.id);
                    div.onclick = () => selectActivity(doc.id, activity.name);
                    div.innerHTML = `
                        <div class="activity-info">
                            <h3>${activity.name}</h3>
                            <p>${activity.category} • ${formatTime(activity.totalTime || 0)}</p>
                        </div>
                        <div class="activity-actions">
                            <button class="btn secondary" onclick="event.stopPropagation(); archiveActivity('${doc.id}')">Archivia</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Errore nel caricamento delle attività:', error);
            }
        }

        function selectActivity(id, name) {
            // Remove selection from all activities
            document.querySelectorAll('.activity-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to clicked activity
            document.querySelector(`[data-id="${id}"]`).classList.add('selected');
            
            currentActivityId = id;
            document.getElementById('currentActivity').textContent = name;
            document.getElementById('startBtn').disabled = false;
        }

        // Timer Management
        function startTimer() {
            if (!currentActivityId) return;
            
            startTime = Date.now();
            currentTimer = setInterval(updateTimerDisplay, 1000);
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
        }

        async function stopTimer() {
            if (!currentTimer || !currentActivityId) return;
            
            clearInterval(currentTimer);
            const endTime = Date.now();
            const duration = endTime - startTime;
            
            try {
                // Save time entry with current date
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                
                await db.collection('timeEntries').add({
                    activityId: currentActivityId,
                    startTime: new Date(startTime),
                    endTime: new Date(endTime),
                    duration: duration,
                    date: dateStr,
                    createdAt: now
                });
                
                // Update activity total time
                const activityRef = db.collection('activities').doc(currentActivityId);
                const activityDoc = await activityRef.get();
                const currentTotal = activityDoc.data().totalTime || 0;
                await activityRef.update({
                    totalTime: currentTotal + duration
                });
                
                // Reset timer
                currentTimer = null;
                startTime = null;
                document.getElementById('timerDisplay').textContent = '00:00:00';
                document.getElementById('currentActivity').textContent = 'Seleziona un\'attività';
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
                
                // Remove selection from all activities
                document.querySelectorAll('.activity-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                currentActivityId = null;
                loadActiveActivities();
            } catch (error) {
                console.error('Errore nel salvataggio del tempo:', error);
                alert('Errore nel salvataggio del tempo');
            }
        }

        function updateTimerDisplay() {
            if (!startTime) return;
            const elapsed = Date.now() - startTime;
            const formattedTime = formatTime(elapsed);
            document.getElementById('timerDisplay').textContent = formattedTime;
        }

        // Archive Management
        async function archiveActivity(id) {
            try {
                await db.collection('activities').doc(id).update({
                    archived: true,
                    archivedAt: new Date()
                });
                loadActiveActivities();
                console.log('Attività archiviata con successo');
            } catch (error) {
                console.error('Errore nell\'archiviazione:', error);
                alert('Errore nell\'archiviazione dell\'attività: ' + error.message);
            }
        }

        async function restoreActivity(id) {
            try {
                await db.collection('activities').doc(id).update({
                    archived: false
                });
                loadArchivedActivities();
                console.log('Attività ripristinata con successo');
            } catch (error) {
                console.error('Errore nel ripristino:', error);
                alert('Errore nel ripristino dell\'attività: ' + error.message);
            }
        }

        async function loadArchivedActivities() {
            try {
                const snapshot = await db.collection('activities').where('archived', '==', true).get();
                const container = document.getElementById('archivedActivities');
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state"><h3>Nessuna attività archiviata</h3><p>Le attività archiviate appariranno qui</p></div>';
                    return;
                }

                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const activity = doc.data();
                    const div = document.createElement('div');
                    div.className = 'activity-item';
                    div.innerHTML = `
                        <div class="activity-info">
                            <h3>${activity.name} <span class="archived-badge">Archiviata</span></h3>
                            <p>${activity.category} • ${formatTime(activity.totalTime || 0)}</p>
                        </div>
                        <div class="activity-actions">
                            <button class="btn" onclick="restoreActivity('${doc.id}')">Ripristina</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
                console.log('Caricate', snapshot.size, 'attività archiviate');
            } catch (error) {
                console.error('Errore nel caricamento delle attività archiviate:', error);
            }
        }

        // Period Selection
        function selectPeriod(period) {
            selectedPeriod = period;
            
            // Update tab appearance
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            const customSection = document.getElementById('customDateSection');
            if (period === 'custom') {
                customSection.classList.add('active');
                setDefaultCustomDates();
            } else {
                customSection.classList.remove('active');
                updateStats();
            }
        }

        function setDefaultCustomDates() {
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
        }

        function applyCustomDates() {
            if (!document.getElementById('startDate').value || !document.getElementById('endDate').value) {
                alert('Seleziona entrambe le date');
                return;
            }
            updateStats();
        }

        // Statistics and Timeline Chart
        async function updateStats() {
            const customSection = document.getElementById('customDateSection');
            
            if (selectedPeriod === 'custom') {
                if (!document.getElementById('startDate').value || !document.getElementById('endDate').value) {
                    return;
                }
            }
            
            const dateRange = getTimelineDateRange(selectedPeriod);
            
            try {
                const snapshot = await db.collection('timeEntries')
                    .where('date', '>=', dateRange.start)
                    .where('date', '<=', dateRange.end)
                    .get();
                
                const timelineData = await processTimelineData(snapshot, dateRange);
                displayTimelineStats(timelineData);
                updateTimelineChart(timelineData, selectedPeriod);
                updatePieChart(timelineData);
            } catch (error) {
                console.error('Errore nel caricamento delle statistiche:', error);
            }
        }

        function getTimelineDateRange(period) {
            const now = new Date();
            let start, end = now.toISOString().split('T')[0];
            
            switch (period) {
                case 'day':
                    start = new Date(now.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    break;
                case 'week':
                    start = new Date(now.getTime() - 27 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    break;
                case 'month':
                    start = new Date(now.getTime() - 179 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    break;
                case 'year':
                    start = new Date(now.getTime() - 364 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    break;
                case 'custom':
                    start = document.getElementById('startDate').value;
                    end = document.getElementById('endDate').value;
                    break;
            }
            
            return { start, end };
        }

        async function processTimelineData(snapshot, dateRange) {
            const activities = {};
            const dates = generateDateRange(dateRange.start, dateRange.end);
            const activityIds = new Set();
            
            // Initialize data structure
            snapshot.forEach(doc => {
                const entry = doc.data();
                activityIds.add(entry.activityId);
            });
            
            // Get activity names
            const activityNames = {};
            if (activityIds.size > 0) {
                const activityPromises = Array.from(activityIds).map(id => 
                    db.collection('activities').doc(id).get()
                );
                const activityDocs = await Promise.all(activityPromises);
                activityDocs.forEach(doc => {
                    if (doc.exists) {
                        activityNames[doc.id] = doc.data().name;
                    }
                });
            }
            
            // Initialize activities data
            activityIds.forEach(id => {
                activities[id] = {
                    name: activityNames[id] || 'Attività sconosciuta',
                    dailyTime: {},
                    totalTime: 0
                };
                dates.forEach(date => {
                    activities[id].dailyTime[date] = 0;
                });
            });
            
            // Process entries
            snapshot.forEach(doc => {
                const entry = doc.data();
                const date = entry.date;
                const duration = entry.duration || 0;
                
                if (activities[entry.activityId] && activities[entry.activityId].dailyTime[date] !== undefined) {
                    activities[entry.activityId].dailyTime[date] += duration;
                    activities[entry.activityId].totalTime += duration;
                }
            });
            
            return { activities, dates };
        }

        function generateDateRange(startDate, endDate) {
            const dates = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                dates.push(d.toISOString().split('T')[0]);
            }
            
            return dates;
        }

        function displayTimelineStats(data) {
            const container = document.getElementById('statsGrid');
            const totalActivities = Object.keys(data.activities).length;
            const totalTime = Object.values(data.activities).reduce((sum, activity) => sum + activity.totalTime, 0);
            const avgDaily = totalTime / data.dates.length;
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${formatTime(totalTime)}</div>
                    <div class="stat-label">Tempo Totale</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatTime(avgDaily)}</div>
                    <div class="stat-label">Media Giornaliera</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalActivities}</div>
                    <div class="stat-label">Attività</div>
                </div>
            `;
        }

        function updateTimelineChart(data, period) {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (timelineChart) {
                timelineChart.destroy();
            }
            
            const colors = ['#007aff', '#34c759', '#ff9500', '#ff3b30', '#af52de', '#5ac8fa', '#ffcc00', '#ff6b6b'];
            const datasets = [];
            
            Object.values(data.activities).forEach((activity, index) => {
                const activityData = data.dates.map(date => 
                    Math.round(activity.dailyTime[date] / 60000) // Convert to minutes
                );
                
                datasets.push({
                    label: activity.name,
                    data: activityData,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                });
            });
            
            const labels = data.dates.map(date => {
                const d = new Date(date);
                if (selectedPeriod === 'day') {
                    return d.toLocaleDateString('it-IT', { month: 'short', day: 'numeric' });
                } else if (selectedPeriod === 'week') {
                    return d.toLocaleDateString('it-IT', { month: 'short', day: 'numeric' });
                } else {
                    return d.toLocaleDateString('it-IT', { month: 'short', day: 'numeric' });
                }
            });
            
            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1d1d1f',
                            bodyColor: '#1d1d1f',
                            borderColor: '#d2d2d7',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const minutes = context.parsed.y;
                                    const hours = Math.floor(minutes / 60);
                                    const mins = minutes % 60;
                                    return `${context.dataset.label}: ${hours}h ${mins}m`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#f0f0f0',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#86868b',
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f0f0f0',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#86868b',
                                callback: function(value) {
                                    const hours = Math.floor(value / 60);
                                    const minutes = value % 60;
                                    if (hours > 0) {
                                        return minutes > 0 ? `${hours}h ${minutes}m` : `${hours}h`;
                                    }
                                    return `${minutes}m`;
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            hoverBackgroundColor: '#fff',
                            hoverBorderWidth: 2
                        }
                    }
                }
            });
        }

        function updatePieChart(data) {
            const ctx = document.getElementById('pieChart').getContext('2d');
            
            if (pieChart) {
                pieChart.destroy();
            }
            
            const colors = ['#007aff', '#34c759', '#ff9500', '#ff3b30', '#af52de', '#5ac8fa', '#ffcc00', '#ff6b6b'];
            const labels = [];
            const chartData = [];
            
            Object.values(data.activities).forEach((activity, index) => {
                if (activity.totalTime > 0) {
                    labels.push(activity.name);
                    chartData.push(Math.round(activity.totalTime / 60000)); // Convert to minutes
                }
            });
            
            if (chartData.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillStyle = '#86868b';
                ctx.font = '16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Nessun dato disponibile per il periodo selezionato', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            pieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: chartData,
                        backgroundColor: colors.slice(0, chartData.length),
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const minutes = data.datasets[0].data[i];
                                            const hours = Math.floor(minutes / 60);
                                            const mins = minutes % 60;
                                            const timeStr = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
                                            
                                            return {
                                                text: `${label} (${timeStr})`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                pointStyle: 'circle',
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1d1d1f',
                            bodyColor: '#1d1d1f',
                            borderColor: '#d2d2d7',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    const minutes = context.parsed;
                                    const hours = Math.floor(minutes / 60);
                                    const mins = minutes % 60;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((minutes / total) * 100).toFixed(1);
                                    return `${context.label}: ${hours}h ${mins}m (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%',
                    elements: {
                        arc: {
                            borderWidth: 0
                        }
                    }
                }
            });
        }

        // Handle period filter change - REMOVED OLD FUNCTION

        // Utility Functions
        function formatTime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadActiveActivities();
        });
    </script>
</body>
</html>
